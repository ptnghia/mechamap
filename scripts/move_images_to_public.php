<?php

/**
 * Script ƒë·ªÉ di chuy·ªÉn h√¨nh ·∫£nh t·ª´ root/images v√†o public/images
 * ƒê·∫£m b·∫£o s·ª≠ d·ª•ng ƒë√∫ng h√¨nh ·∫£nh th·ª±c t·∫ø cho Thread v√† Showcase
 */

class ImageMigrationScript
{
    private $sourceDir;
    private $targetDir;
    private $movedFiles = [];
    private $errors = [];
    
    public function __construct()
    {
        $this->sourceDir = __DIR__ . '/../images';
        $this->targetDir = __DIR__ . '/../public/images';
    }
    
    /**
     * Th·ª±c hi·ªán di chuy·ªÉn t·∫•t c·∫£ h√¨nh ·∫£nh
     */
    public function migrate()
    {
        echo "üöÄ STARTING IMAGE MIGRATION TO PUBLIC/IMAGES\n";
        echo "============================================\n\n";
        
        // 1. T·∫°o backup tr∆∞·ªõc khi di chuy·ªÉn
        $this->createBackup();
        
        // 2. T·∫°o c·∫•u tr√∫c th∆∞ m·ª•c ƒë√≠ch
        $this->createTargetDirectories();
        
        // 3. Di chuy·ªÉn t·ª´ng category
        $this->migrateThreadImages();
        $this->migrateShowcaseImages();
        $this->migrateUserImages();
        $this->migrateCategoryImages();
        $this->migrateSettingImages();
        
        // 4. T·∫°o b√°o c√°o
        $this->generateReport();
        
        echo "‚úÖ Migration completed successfully!\n";
    }
    
    /**
     * T·∫°o backup
     */
    private function createBackup()
    {
        echo "üíæ Creating backup...\n";
        
        $backupDir = __DIR__ . '/../storage/app/backup/images_migration_' . date('Y-m-d_H-i-s');
        
        if (!file_exists(dirname($backupDir))) {
            mkdir(dirname($backupDir), 0755, true);
        }
        
        $this->copyDirectory($this->targetDir, $backupDir);
        echo "  ‚úÖ Backup created: " . basename($backupDir) . "\n\n";
    }
    
    /**
     * T·∫°o c·∫•u tr√∫c th∆∞ m·ª•c ƒë√≠ch
     */
    private function createTargetDirectories()
    {
        echo "üìÅ Creating target directories...\n";
        
        $directories = [
            'threads',
            'showcases', 
            'users/avatars',
            'categories',
            'brand',
            'temp'
        ];
        
        foreach ($directories as $dir) {
            $fullPath = $this->targetDir . '/' . $dir;
            if (!file_exists($fullPath)) {
                mkdir($fullPath, 0755, true);
                echo "  üìÇ Created: {$dir}\n";
            }
        }
        echo "\n";
    }
    
    /**
     * Di chuy·ªÉn thread images
     */
    private function migrateThreadImages()
    {
        echo "üìù Migrating thread images...\n";
        
        $sourceDir = $this->sourceDir . '/threads';
        $targetDir = $this->targetDir . '/threads';
        
        if (!file_exists($sourceDir)) {
            echo "  ‚ö†Ô∏è  Source directory not found: {$sourceDir}\n";
            return;
        }
        
        $files = glob($sourceDir . '/*');
        $moved = 0;
        
        foreach ($files as $file) {
            if (is_file($file)) {
                $filename = basename($file);
                $targetFile = $targetDir . '/' . $filename;
                
                if (!file_exists($targetFile)) {
                    if (copy($file, $targetFile)) {
                        $this->movedFiles[] = [
                            'from' => $file,
                            'to' => $targetFile,
                            'category' => 'threads'
                        ];
                        $moved++;
                        echo "  üìÑ Moved: {$filename}\n";
                    } else {
                        $this->errors[] = "Failed to copy: {$filename}";
                    }
                } else {
                    echo "  ‚è≠Ô∏è  Skipped (exists): {$filename}\n";
                }
            }
        }
        
        echo "  ‚úÖ Moved {$moved} thread images\n\n";
    }
    
    /**
     * Di chuy·ªÉn showcase images
     */
    private function migrateShowcaseImages()
    {
        echo "üèÜ Migrating showcase images...\n";
        
        $sourceDir = $this->sourceDir . '/showcase';
        $targetDir = $this->targetDir . '/showcases';
        
        if (!file_exists($sourceDir)) {
            echo "  ‚ö†Ô∏è  Source directory not found: {$sourceDir}\n";
            return;
        }
        
        $files = glob($sourceDir . '/*');
        $moved = 0;
        
        foreach ($files as $file) {
            if (is_file($file)) {
                $filename = basename($file);
                $targetFile = $targetDir . '/' . $filename;
                
                if (!file_exists($targetFile)) {
                    if (copy($file, $targetFile)) {
                        $this->movedFiles[] = [
                            'from' => $file,
                            'to' => $targetFile,
                            'category' => 'showcases'
                        ];
                        $moved++;
                        echo "  üìÑ Moved: {$filename}\n";
                    } else {
                        $this->errors[] = "Failed to copy: {$filename}";
                    }
                } else {
                    echo "  ‚è≠Ô∏è  Skipped (exists): {$filename}\n";
                }
            }
        }
        
        echo "  ‚úÖ Moved {$moved} showcase images\n\n";
    }
    
    /**
     * Di chuy·ªÉn user images
     */
    private function migrateUserImages()
    {
        echo "üë§ Migrating user images...\n";
        
        $sourceDir = $this->sourceDir . '/users';
        $targetDir = $this->targetDir . '/users/avatars';
        
        if (!file_exists($sourceDir)) {
            echo "  ‚ö†Ô∏è  Source directory not found: {$sourceDir}\n";
            return;
        }
        
        $files = glob($sourceDir . '/*');
        $moved = 0;
        
        foreach ($files as $file) {
            if (is_file($file)) {
                $filename = basename($file);
                $targetFile = $targetDir . '/' . $filename;
                
                if (!file_exists($targetFile)) {
                    if (copy($file, $targetFile)) {
                        $this->movedFiles[] = [
                            'from' => $file,
                            'to' => $targetFile,
                            'category' => 'users'
                        ];
                        $moved++;
                        echo "  üìÑ Moved: {$filename}\n";
                    } else {
                        $this->errors[] = "Failed to copy: {$filename}";
                    }
                } else {
                    echo "  ‚è≠Ô∏è  Skipped (exists): {$filename}\n";
                }
            }
        }
        
        echo "  ‚úÖ Moved {$moved} user images\n\n";
    }
    
    /**
     * Di chuy·ªÉn category images
     */
    private function migrateCategoryImages()
    {
        echo "üè∑Ô∏è  Migrating category images...\n";
        
        $sourceDir = $this->sourceDir . '/category-forum';
        $targetDir = $this->targetDir . '/categories';
        
        if (!file_exists($sourceDir)) {
            echo "  ‚ö†Ô∏è  Source directory not found: {$sourceDir}\n";
            return;
        }
        
        $files = glob($sourceDir . '/*');
        $moved = 0;
        
        foreach ($files as $file) {
            if (is_file($file)) {
                $filename = basename($file);
                $targetFile = $targetDir . '/' . $filename;
                
                if (!file_exists($targetFile)) {
                    if (copy($file, $targetFile)) {
                        $this->movedFiles[] = [
                            'from' => $file,
                            'to' => $targetFile,
                            'category' => 'categories'
                        ];
                        $moved++;
                        echo "  üìÑ Moved: {$filename}\n";
                    } else {
                        $this->errors[] = "Failed to copy: {$filename}";
                    }
                } else {
                    echo "  ‚è≠Ô∏è  Skipped (exists): {$filename}\n";
                }
            }
        }
        
        echo "  ‚úÖ Moved {$moved} category images\n\n";
    }
    
    /**
     * Di chuy·ªÉn setting images
     */
    private function migrateSettingImages()
    {
        echo "‚öôÔ∏è  Migrating setting images...\n";
        
        $sourceDir = $this->sourceDir . '/setting';
        $targetDir = $this->targetDir . '/brand';
        
        if (!file_exists($sourceDir)) {
            echo "  ‚ö†Ô∏è  Source directory not found: {$sourceDir}\n";
            return;
        }
        
        $files = glob($sourceDir . '/*');
        $moved = 0;
        
        foreach ($files as $file) {
            if (is_file($file)) {
                $filename = basename($file);
                $targetFile = $targetDir . '/' . $filename;
                
                if (!file_exists($targetFile)) {
                    if (copy($file, $targetFile)) {
                        $this->movedFiles[] = [
                            'from' => $file,
                            'to' => $targetFile,
                            'category' => 'brand'
                        ];
                        $moved++;
                        echo "  üìÑ Moved: {$filename}\n";
                    } else {
                        $this->errors[] = "Failed to copy: {$filename}";
                    }
                } else {
                    echo "  ‚è≠Ô∏è  Skipped (exists): {$filename}\n";
                }
            }
        }
        
        echo "  ‚úÖ Moved {$moved} setting images\n\n";
    }
    
    /**
     * Copy directory recursively
     */
    private function copyDirectory($source, $destination)
    {
        if (!file_exists($source)) return;
        
        if (!file_exists($destination)) {
            mkdir($destination, 0755, true);
        }
        
        $iterator = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator($source, RecursiveDirectoryIterator::SKIP_DOTS),
            RecursiveIteratorIterator::SELF_FIRST
        );
        
        foreach ($iterator as $item) {
            $target = $destination . DIRECTORY_SEPARATOR . $iterator->getSubPathName();
            
            if ($item->isDir()) {
                if (!file_exists($target)) {
                    mkdir($target, 0755, true);
                }
            } else {
                copy($item, $target);
            }
        }
    }
    
    /**
     * T·∫°o b√°o c√°o
     */
    private function generateReport()
    {
        echo "üìã MIGRATION REPORT\n";
        echo "==================\n";
        
        $totalMoved = count($this->movedFiles);
        $totalErrors = count($this->errors);
        
        echo "üìä Total files moved: {$totalMoved}\n";
        echo "‚ùå Total errors: {$totalErrors}\n\n";
        
        // Group by category
        $byCategory = [];
        foreach ($this->movedFiles as $file) {
            $category = $file['category'];
            if (!isset($byCategory[$category])) {
                $byCategory[$category] = 0;
            }
            $byCategory[$category]++;
        }
        
        echo "üìÅ Files moved by category:\n";
        foreach ($byCategory as $category => $count) {
            echo "  - {$category}: {$count} files\n";
        }
        
        if (!empty($this->errors)) {
            echo "\n‚ùå Errors:\n";
            foreach ($this->errors as $error) {
                echo "  - {$error}\n";
            }
        }
        
        // Save detailed report
        $reportData = [
            'migration_date' => date('Y-m-d H:i:s'),
            'total_moved' => $totalMoved,
            'total_errors' => $totalErrors,
            'moved_files' => $this->movedFiles,
            'errors' => $this->errors,
            'by_category' => $byCategory
        ];
        
        $reportPath = __DIR__ . '/image_migration_report_' . date('Y-m-d_H-i-s') . '.json';
        file_put_contents($reportPath, json_encode($reportData, JSON_PRETTY_PRINT));
        
        echo "\nüìÑ Detailed report saved: " . basename($reportPath) . "\n";
    }
}

// Ch·∫°y migration n·∫øu script ƒë∆∞·ª£c g·ªçi tr·ª±c ti·∫øp
if (php_sapi_name() === 'cli') {
    $migration = new ImageMigrationScript();
    $migration->migrate();
}
